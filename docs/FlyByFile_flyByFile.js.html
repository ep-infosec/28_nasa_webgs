<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: FlyByFile/flyByFile.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: FlyByFile/flyByFile.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 *
 * @module flyByFile
 * @version 1.0.0
 * @description &lt;b> Library of save file functions. &lt;/b>
 * Save documents to the server in Examples folder.
 * @example none
 * @author Andrew Peters
 * @date May 2019
 * @copyright
 * there will be one
 *
 *
 *
 *
 */


import * as mode from '../MainJS/gcsmode.js';
import * as comms from '../MainJS/comms.js';
import * as Aircraft from '../MainJS/aircraft.js';
import * as E from '../MainJS/eventFunctions.js'
import * as G from '../Geofence/geofence.js'


/**
 * @function &lt;a name="flybyfile">flybyfile&lt;/a>
 * @description Take text from a loaded file and turn that into a series of commands that the front end can execute.
 * @param none
 * @returns {Promise.&lt;void>} Starts scriptLoop as async function.
 * @memberof module:flyByFile
 */
export async function flybyfile() {
    let c_list = document.getElementsByClassName('fileplan')
    let text = c_list[0].innerHTML
    let lines = text.split('\n')
    let MODE = E.getMode()
    MODE.flybyfile = true

    let command_list = [
        'repeat',
        'const',
        'param',
        'start',
        'wp',
        'geofence',
        'time',
        'long',
        'traffic',
        'wind', // will be used later
        'stop',
        'adjust',
        '#', // comments
        '' // blank lines
    ]

    let words;
    let line_num = 0
    let command_num = 0
    let repeat = 1
    let adjust_list = []
    let command;
    let com;
    let func;
    let fun;
    let args;
    let x;
    let rep;
    let exp_args = [];
    let prev_ind;
    let acount = 0
    let w
    let v
    let h = false
    let const_obj = {}

    // check for errors or unknown commands
    for (let line of lines) {
        // split on the first space ignore the rest
        words = line.split(/ (.*)/)

        // increase line num
        line_num += 1
        // increase command num
        if (words[0] != '' &amp;&amp; words[0] != '#') {
            command_num += 1
        }

        // check for unknown commands
        if (!command_list.includes(words[0])) {
            console.log('Line: ' + line_num + ' Unknown Command: ' + words[0])
            form.alertBannerRed('Line: ' + line_num + ' Unknown Command: ' + words[0])
            return
        }

        // repeat must be at the top
        if (command_num == 1) {
            if (words[0] == 'repeat') {
                try {
                    repeat = parseInt(words[1])
                } catch (e) {
                    console.log('Repeat Value not an Int, Line: ', line_num)
                    form.alertBannerRed('Repeat Value not an Int, Line: ', line_num)
                }

            }
        } else if (words[0] == 'repeat') {
            console.log('Line: ' + line_num + ' Unexpected Repeat')
            form.alertBannerRed('Line: ' + line_num + ' Unexpected Repeat')
            return
        }

        // get constants
        if (words[0] == 'const') {
            w = words[1].split(' ')
            console.log(w[0], w[1])
            const_obj[w[0]] = w[1]
            console.log(const_obj)
            h = true
        }

        // check for words in constants list
        if (h &amp;&amp; words[1]) {
            for (let key in const_obj) {
                v = words[1].split(/[' ',\,,\(,\)]/g)
                for (let i = v.length - 1; i >= 0; i--) {
                    if (v[i] == key) {
                        v[i] = const_obj[key]
                    } else if (v[i] == '') {
                        v.splice(i, 1)
                    }
                }
                words[1] = v.join(', ') + ')'
            }
        }

        // deal with adjust
        if (words[0] == 'adjust') {
            if (repeat == 0) {
                console.log('Unexpected Adjust command, line: ', line_num)
                form.alertBannerRed('Unexpected Adjust command, line: ', line_num)
                return
            } else if (words.length != 3) {
                console.log('Adjust command given incorrect number of arguments, line: ', line_num)
                form.alertBannerRed('Adjust command given incorrect number of arguments, line: ', line_num)
                return
            } else {
                acount++
                exp_args = []
                // parse the command
                command = words[1].split(/ (.*)/)
                com = command[0]
                func = command[1].replace('(', ',').replace(')', '').replace(/\s/g, '').split(',')
                console.log(func)
                args = func.slice(1, func.length)

                // expand args ex [args, *2]  = [args, args]
                prev_ind = -1
                args = args.filter((el, ind) => {
                    if (el.includes('*')) {
                        rep = el.split('*')
                        rep = parseInt(rep[1])
                        for (let i = 0; i &lt; rep; i++) {
                            exp_args = exp_args.concat(args.slice(prev_ind + 1, ind))

                        }
                        prev_ind = ind
                        return
                    }
                })

                // get the number of args passed on each repeat
                if (exp_args.length % repeat == 0) {
                    x = exp_args.length / (repeat)
                } else {
                    console.log('Adjust inner function given incorrect number of arguments, line: ', line_num)
                    form.alertBannerRed('Adjust inner function given incorrect number of arguments, line: ', line_num)
                    return
                }

                // build the command
                for (let i = 0; i &lt; repeat; i++) {
                    fun = func[0] + '(' + exp_args.slice(i * x, ((i + 1) * x)).join(', ') + ')'

                    // allows for multiple adjust commands
                    adjust_list.splice((i * acount + acount) - 1, 0, [com, fun])
                }

            }
        }
    }

    let script = []
    // handle the repeat and adjust
    script.push(['stop', 'all'])
    let next
    for (let r = 0; r &lt; repeat; r++) {
        // add a comment to show how far into the script we are
        script.push(['comment', (r), repeat])

        for (let line of lines) {
            words = line.split(/ (.*)/)
            // skip repeat, any blank lines, or comments
            if (words[0] != 'repeat' &amp;&amp; words[0] != '' &amp;&amp; words[0] != '#') {
                if (words[0] == 'adjust') {
                    next = adjust_list.shift()
                    script.push(next)
                } else {
                    script.push(words)
                }
            }
        }
        // check insert stop all after last command before repeating
        script.push(['stop', 'all'])
    }
    // insert EOF marker to break out of loop
    script.push(['END', 'TEST'])
    console.log(script)

    // run the script
    await scriptLoop(script)
    MODE.flybyfile = false
}


/**
 * @function &lt;a name="scriptLoop">scriptLoop&lt;/a>
 * @description Takes a formated script and executes the commands.
 * @param script {Array} List of commands to be run.
 * @memberof module:flyByFile
 */
async function scriptLoop(script) {
    // run the script
    // TODO: find better way to send next commands
    let timeout_table = {
        start: 50,
        stop: 1000,
        param: 50,
        time: 1000,
        long: 50,
        traffic: 50,
        wp: 50,
        geofence: 50,
        comment: 1,
        wind: 5000
    }

    // turn on banner for fly by file
    let banner = document.createElement('div')
    banner.setAttribute('id', 'b_banner')
    banner.setAttribute('class', 'b_overlay')
    let b_text = document.createElement('div')
    b_text.setAttribute('id', 'b_text')
    b_text.innerHTML = 'Fly by File in progress. Completed 0 of 0 flights.'
    banner.appendChild(b_text)
    document.body.appendChild(banner)

    let start = Date.now()
    let last = Date.now()
    let a_list;

    // start the script
    for (let line of script) {
        // finish cleaning up the command
        a_list = parseMessage(line)

        // Run the command
        functionSwitch(line, a_list)

        // check for wait time
        if (line[0] == 'time') {
            timeout_table['time'] = parseInt(a_list[1]) * 1000
        }

        // using timeout after the function call to guarantee the function waits before the next line is executed
        await new Promise((resolve, reject) => setTimeout(resolve, timeout_table[line[0]]))
        console.log('Total Run Time: ', (Date.now() - start) / 1000)
        console.log('Time since last command: ', (Date.now() - last) / 1000)
        last = Date.now()

    }

    // remove the banner
    banner.parentNode.removeChild(banner)
}


/**
 * @function &lt;a name="parseMessage">parseMessage&lt;/a>
 * @description Parses a line from the script and returns it as a cleaned array.
 * @param line {string} string.
 * @returns {Array}
 * @memberof module:flyByFile
 */
function parseMessage(line) {
    let line_list
    if (line[0] != 'comment') {
        line_list = line[1].replace(')', '').replace('(', ', ').split(', ')
    }
    return line_list
}


/**
 * @function &lt;a name="functionSwitch">functionSwitch&lt;/a>
 * @description Executes the lines of the script.
 * @param line {string} string.
 * @param a_list {Array} list of strings used as parameters for a function
 * @memberof module:flyByFile
 */
function functionSwitch(line, a_list) {
    let ac
    // just in case
    line[0] = line[0].replace(/[\,'\(,\),\{,\},\[,\]]/g, '')
    switch (line[0]) {
        case 'param':
            // expected format - ['file', id, 'path/to/new/file.txt']
            // expected format - ['single', id, param_id, param_value, param_type]
            let message
            ac = Aircraft.getAircraftByName(a_list[1])
            if (a_list[0] == 'file') {
                message = 'AIRCRAFT ' + ac.id +
                    ' LOAD_PARAM_FILE ' + '/' + a_list[2]

            } else if (a_list[0] == 'single') {
                message = 'AIRCRAFT ' + a_list[1] +
                    ' CHANGE_PARAM ' + a_list[2] +
                    ' ' + a_list[3] +
                    ' ' + a_list[4]
            }
            comms.sendFullMessage(message)
            break;

        case 'start':
            // expected format - start newAC(name, icarous(y/n), lat, lng))
            E.createNewAircraftFile(a_list[1], a_list[2], parseFloat(a_list[3]), parseFloat(a_list[4]))
            console.log('Waiting for AC Startup.')
            break;

        case 'wp':
            // expected format - ['wp', 'load', id, 'path/to/file.txt']

            console.log(a_list)
            // comms.sendFullMessage('AIRCRAFT ' + ac.id + ' LOAD_WP_FILE ' + a_list)
            // open the file
            let allText;
            let rawFile = new XMLHttpRequest() // This is depreciated will have to find a fix in the future
            rawFile.open('GET', a_list[2], false)
            rawFile.onreadystatechange = function () {
                if (rawFile.readyState === 4) {
                    if (rawFile.status === 200) {
                        allText = rawFile.responseText
                    }
                }
            }
            rawFile.send(null);
            let text = allText.split('\n')
            let clean_text = []
            for (let item of text) {
                item = item.split('\t')
                clean_text.push(item)
            }

            // seq, ignore, ignore, command, ignore, ignore, ignore, ignore, lat, lng, alt
            let vel
            let wp_string = ''
            // format for curent LOAD_FLIGHTPLAN message
            for (let item of clean_text) {
                if (item.length == 12) {
                    // ignore 0.000 lat or long
                    if (parseFloat(item[8]) == 0.0 || parseFloat(item[9]) == 0.0) {
                        vel = item[5]
                    } else {
                        wp_string = wp_string + ' ' + item[8] + ' ' + item[9] + ' ' + item[10]
                    }
                }
            }
            ac = Aircraft.getAircraftByName(a_list[1])

            // send the message
            E.scriptSubmitFlightPlan(ac, vel, wp_string + ' ')

            // request the wp's from the ac to update the display
            comms.sendFullMessage('AIRCRAFT ' + ac.id + ' REQUEST_WAYPOINTS ' + ac.id);

            break;

        case 'geofence':
            // expected format - ['geofence', 'load', id, fence_id, 'path/to/file.xml']
            ac = Aircraft.getAircraftByName(a_list[1])

            // load the file
            comms.sendFullMessage('AIRCRAFT ' + ac.id + ' LOAD_GF_FILE ' + '../../' + a_list[3])

            // submit the fence to ac

            let x = true
            setTimeout(() => {
                console.log('waiting for points')
                try {

                    for (let f of ac.gf_list) {
                        let m = 'LOAD_GEOFENCE AC_ID ' + ac.id +
                            ' F_ID ' + parseInt(f.id) +
                            ' TYPE ' + parseInt(f.type) +
                            ' FLOOR ' + parseInt(f.floor) +
                            ' ROOF ' + parseInt(f.roof)
                        for (let p of f.point_list) {
                            m = m + ' ' + p.lat.toString() + ' ' + p.lng.toString()
                        }

                        comms.sendFullMessage('AIRCRAFT ' + ac.id + ' ' + m)

                        // update fence and status
                        f.submitted = true;
                        G.updateFenceSummaryPanel()

                        // show loading panel
                        G.createLoadingPanel('sendgeofence', ac)
                        G.makeGfPanelActive('loading_ac_sendgeofence')

                        // redraw the fence lines
                        G.drawGeofences()
                    }

                } catch (e) {
                    console.log(e)
                }
            }, 5000)

            break;

        case 'time':
            // expected format - ['time', 'wait', num]
            setTimeout(console.log('Wait ' + line[1]), parseInt(line[2]) * 1000)
            break;

        case 'long':
            // expected format - ['long', 'MISSION_START', id]
            ac = Aircraft.getAircraftByName(a_list[1])
            E.clickSendStartFlight('x', ac)

            break;

        case 'traffic':
            if (a_list[0] == 'add') {
                // expected format: a_list - ['add', id, t_id, lat, lng, range, bearing, alt, gs, hdg, vs, emit]
                let ac = Aircraft.getAircraftByName(a_list[1])
                // format the message
                let msg = 'AIRCRAFT ' + ac.id +
                    ' ADD_TRAFFIC ' + a_list[2] +
                    ' ' + a_list[3] +
                    ' ' + a_list[4] +
                    ' ' + a_list[5] +
                    ' ' + a_list[6] +
                    ' ' + a_list[7] +
                    ' ' + a_list[8] +
                    ' ' + a_list[9] +
                    ' ' + a_list[10] +
                    ' ' + a_list[11]


                // send the message
                comms.sendFullMessage(msg)

            } else if (a_list[0] == 'file') {
                // expected format - [file, id, t_id, filename]
                let ac = Aircraft.getAircraftByName(a_list[1])
                let t_id = a_list[2]
                let filename = '/' + a_list[3]
                comms.sendFullMessage('AIRCRAFT ' + ac.id + ' FILE_TRAFFIC ' + t_id + ' ' + filename)

            } else if (a_list[0] === 'remove') {
                // expected format - [remove, id, t_id]
                let ac = Aircraft.getAircraftByName(a_list[1])
                let t_id = a_list[2]
                comms.sendFullMessage('AIRCRAFT ' + ac.id + ' REMOVE_TRAFFIC ' + t_id)
            }
            break;
        case 'comment':
            // update banner
            let b_t = document.getElementById('b_text')
            b_t.innerHTML = 'Fly by File in progress. Completed ' + line[1].toString() + '  of ' + line[2].toString() + ' flights.'
            break;

        case 'stop':
            // expected format: line - ['stop', 'ac'], or ['stop', 'all']

            if (line[1] == 'all') {
                let ac_list = comms.getAircraftList()
                ac_list.forEach(el => {
                    Aircraft.acShutdown(el)
                });
            } else {
                try {
                    let ac_name = line[1]
                    let ac = Aircraft.getAircraftByName(ac_name)
                    mode.acShutdown(ac)
                } catch (e) {
                    console.log('Aircraft not found.', line, e)
                    return
                }
            }
            break;

        case 'END':
            console.log('End of Script')
            let MODE = E.getMode()
            MODE.flybyfile = false
            break;
    }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Aircraft.html">Aircraft</a></li><li><a href="module-comms.html">comms</a></li><li><a href="module-eventFunctions.html">eventFunctions</a></li><li><a href="module-eventFunctionsTraffic.html">eventFunctionsTraffic</a></li><li><a href="module-flyByFile.html">flyByFile</a></li><li><a href="module-form.html">form</a></li><li><a href="module-GeoFence.html">GeoFence</a></li><li><a href="module-geofenceEvents.html">geofenceEvents</a></li><li><a href="module-icSettings.html">icSettings</a></li><li><a href="module-mode.html">mode</a></li><li><a href="module-playback.html">playback</a></li><li><a href="module-saveFile.html">saveFile</a></li><li><a href="module-traffic.html">traffic</a></li><li><a href="module-updateUser.html">updateUser</a></li></ul><h3>Classes</h3><ul><li><a href="module-Aircraft_Aircraft.html">Aircraft</a></li><li><a href="module-Aircraft_Waypoint.html">Waypoint</a></li><li><a href="module-GeoFence_Fence.html">Fence</a></li><li><a href="module-icSettings_icApp.html">icApp</a></li><li><a href="module-icSettings_icAppSettings.html">icAppSettings</a></li><li><a href="module-mode_GCSmode.html">GCSmode</a></li><li><a href="module-traffic_Aircraft.html">Aircraft</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.2</a> on Fri May 24 2019 13:46:40 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
